{% extends "base.html" %}

{% block title %}Rejestracja podróży – Odyseusz 2.0{% endblock %}

{% block head %}
<style>
    /* Stylowanie lokalne – spójne z systemem */
    .trip-card {
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: var(--shadow-soft);
        margin-top: 20px;
    }

    .trip-card h2 {
        margin-bottom: 20px;
        font-size: 22px;
    }

    .input-field {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        font-size: 15px;
    }

    select.input-field {
        cursor: pointer;
    }

    .stage {
        background: #f8f9fc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #e2e6f0;
    }

    .stage input {
        margin-bottom: 8px;
    }

    .removeStageBtn {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 5px;
    }

    .removeStageBtn:hover {
        background: #c0392b;
    }

    #addStageBtn {
        margin-top: 10px;
        background: var(--primary-light);
        color: var(--primary-dark);
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    #addStageBtn:hover {
        background: var(--primary);
        color: #fff;
    }

    button[type="submit"] {
        margin-top: 20px;
    }

    #tripMessage {
        font-weight: bold;
        padding-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="trip-card">
    <h2>Rejestracja podróży</h2>
    <form id="tripForm">
        <input type="hidden" name="traveler_pesel" value="{{ traveler.pesel }}">
        <input type="hidden" name="status" value="planned">

        <h3>Etapy podróży</h3>
        <div id="stagesContainer"></div>

        <button type="button" id="addStageBtn" class="btn-secondary">+ Dodaj etap</button>
        <button type="submit" class="btn">Zarejestruj podróż</button>
    </form>
    <div id="tripMessage"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const tripForm = document.getElementById('tripForm');
const tripMessage = document.getElementById('tripMessage');
const stagesContainer = document.getElementById('stagesContainer');
const addStageBtn = document.getElementById('addStageBtn');

// Słownik na kraje, żeby nie pobierać ich za każdym razem przy dodawaniu etapu
let countriesCache = [];

// Pobierz listę krajów przy starcie
async function fetchCountries() {
    try {
        const res = await fetch('/countries');
        countriesCache = await res.json();
    } catch (err) {
        console.error("Błąd pobierania krajów:", err);
    }
}

async function addStage() {
    if (countriesCache.length === 0) await fetchCountries();

    const div = document.createElement('div');
    div.className = 'stage';
    
    div.innerHTML = `
        <label>Data od - do:</label>
        <div style="display: flex; gap: 10px;">
            <input type="date" name="start_date" class="input-field" required>
            <input type="date" name="end_date" class="input-field" required>
        </div>

        <select class="input-field country-select" required>
            <option value="">-- Wybierz kraj --</option>
            ${countriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
        </select>

        <select class="input-field city-select" name="city_id" disabled required>
            <option value="">-- Najpierw wybierz kraj --</option>
        </select>

        <input type="text" name="address" class="input-field address-input" 
               placeholder="Wpisz adres (np. ul. Polna 1/2)" disabled required>

        <button type="button" class="removeStageBtn">Usuń etap</button>
    `;

    stagesContainer.appendChild(div);

    const countrySelect = div.querySelector('.country-select');
    const citySelect = div.querySelector('.city-select');
    const addressInput = div.querySelector('.address-input');

    countrySelect.addEventListener('change', async () => {
        const countryId = countrySelect.value;
        citySelect.innerHTML = '<option value="">Ładowanie miast...</option>';
        citySelect.disabled = true;
        addressInput.disabled = true;

        if (!countryId) return;

        try {
            const res = await fetch(`/countries/${countryId}/cities`);
            const cities = await res.json();
            
            citySelect.innerHTML = '<option value="">-- Wybierz miasto --</option>';
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city.id;
                opt.textContent = city.name;
                citySelect.appendChild(opt);
            });
            citySelect.disabled = false;
        } catch (err) {
            citySelect.innerHTML = '<option value="">Błąd ładowania</option>';
        }
    });

    // Po wybraniu miasta odblokowujemy wpisywanie adresu
    citySelect.addEventListener('change', () => {
        addressInput.disabled = !citySelect.value;
    });

    div.querySelector('.removeStageBtn').addEventListener('click', () => div.remove());
}

addStageBtn.addEventListener('click', addStage);

// Inicjalizacja
fetchCountries().then(() => addStage());

// SUBMIT FORMULARZA
tripForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(tripForm);
    
    const stages = [];
    stagesContainer.querySelectorAll('.stage').forEach(div => {
        stages.push({
            start_date: div.querySelector('[name="start_date"]').value,
            end_date: div.querySelector('[name="end_date"]').value,
            city_id: parseInt(div.querySelector('[name="city_id"]').value), // Wysyłamy ID miasta
            address: div.querySelector('[name="address"]').value          // Wysyłamy surowy adres
        });
    });

    const payload = {
        traveler_pesel: formData.get('traveler_pesel'),
        status: formData.get('status'),
        stages: stages
    };

    try {
        const res = await fetch('/trips', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await res.json();

        if (res.ok) {
            window.location.href = `/add_companions_to_travel?traveler_pesel=${payload.traveler_pesel}&trip_id=${result.id}`;
        } else {
            tripMessage.textContent = `Błąd: ${result.error}`;
            tripMessage.className = "error-msg";
        }
    } catch (err) {
        tripMessage.textContent = `Błąd sieci: ${err.message}`;
    }
});
</script>
{% endblock %}
