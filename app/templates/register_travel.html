{% extends "base.html" %}

{% block title %}Rejestracja podróży – Odyseusz 2.0{% endblock %}

{% block head %}
<style>
    /* Stylowanie lokalne – spójne z systemem */
    .trip-card {
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: var(--shadow-soft);
        margin-top: 20px;
    }

    .trip-card h2 {
        margin-bottom: 20px;
        font-size: 22px;
    }

    .input-field {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        font-size: 15px;
    }

    select.input-field {
        cursor: pointer;
    }

    .stage {
        background: #f8f9fc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #e2e6f0;
    }

    .stage input {
        margin-bottom: 8px;
    }

    .removeStageBtn {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 5px;
    }

    .removeStageBtn:hover {
        background: #c0392b;
    }

    #addStageBtn {
        margin-top: 10px;
        background: var(--primary-light);
        color: var(--primary-dark);
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    #addStageBtn:hover {
        background: var(--primary);
        color: #fff;
    }

    button[type="submit"] {
        margin-top: 20px;
    }

    #tripMessage {
        font-weight: bold;
        padding-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="trip-card">
    <h2>Rejestracja podróży</h2>

    <form id="tripForm">

        <input type="hidden" name="traveler_pesel" value="{{ traveler.pesel }}">

        <label>Status podróży:</label>
        <select id="statusSelect" name="status" class="input-field" required>
            <option value="planned">Planowana</option>
            <option value="in_progress">W trakcie</option>
            <option value="completed">Zakończona</option>
        </select>

        <h3>Etapy podróży</h3>

        <div id="stagesContainer"></div>

        <button type="button" id="addStageBtn" class="btn-secondary">+ Dodaj etap</button>

        <button type="submit" class="btn">Zarejestruj podróż</button>
    </form>

    <div id="tripMessage"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const tripForm = document.getElementById('tripForm');
const tripMessage = document.getElementById('tripMessage');
const stagesContainer = document.getElementById('stagesContainer');
const addStageBtn = document.getElementById('addStageBtn');

function addStage() {
    const div = document.createElement('div');
    div.className = 'stage';
    div.innerHTML = `
        <input type="date" name="start_date" class="input-field" required>
        <input type="date" name="end_date" class="input-field" required>
        <input type="number" name="location_id" class="input-field" placeholder="ID lokalizacji" required>
        <button type="button" class="removeStageBtn">Usuń etap</button>
    `;
    stagesContainer.appendChild(div);

    div.querySelector('.removeStageBtn').addEventListener('click', () => div.remove());
}

addStageBtn.addEventListener('click', addStage);
addStage(); // domyślny etap

tripForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = Object.fromEntries(new FormData(tripForm));

    const stages = [];
    stagesContainer.querySelectorAll('.stage').forEach(div => {
        const inputs = div.querySelectorAll('input');
        stages.push({
            start_date: inputs[0].value,
            end_date: inputs[1].value,
            location_id: parseInt(inputs[2].value)
        });
    });

    const payload = {
        traveler_pesel: formData.traveler_pesel,
        status: formData.status,
        stages: stages
    };

    try {
        const res = await fetch('/trips', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await res.json();

        if (res.ok) {
            window.location.href =
                `/add_companions_to_travel?traveler_pesel=${formData.traveler_pesel}&trip_id=${result.id}`;
        } else {
            tripMessage.textContent = `Błąd: ${result.error}`;
            tripMessage.style.color = "red";
        }
    } catch (err) {
        tripMessage.textContent = `Błąd sieci: ${err.message}`;
        tripMessage.style.color = "red";
    }
});
</script>
{% endblock %}
