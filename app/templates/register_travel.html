{% extends "base.html" %}

{% block title %}Rejestracja podróży – Odyseusz 2.0{% endblock %}

{% block head %}
<style>
    /* Stylowanie karty podróży */
    .trip-card {
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: var(--shadow-soft);
        margin-top: 20px;
    }

    .trip-card h2 {
        margin-bottom: 20px;
        font-size: 22px;
        color: var(--primary-dark);
    }

    .input-field {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        font-size: 15px;
        transition: border-color 0.2s;
    }

    /* Styl dla zablokowanych pól daty */
    .input-readonly {
        background-color: #f1f3f5 !important;
        cursor: not-allowed;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .input-error {
        border: 2px solid #e74c3c !important;
    }

    .error-text {
        color: #e74c3c;
        font-size: 12px;
        margin-top: -10px;
        margin-bottom: 10px;
        display: none;
        font-weight: bold;
    }

    .stage {
        background: #f8f9fc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e2e6f0;
        position: relative;
    }

    .stage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .date-group {
        display: flex;
        gap: 15px;
        margin-bottom: 5px;
    }

    .date-group div {
        flex: 1;
    }

    .date-group label {
        display: block;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #495057;
    }

    .removeStageBtn {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
    }

    .removeStageBtn:hover {
        background: #c0392b;
    }

    #addStageBtn {
        margin-top: 10px;
        background: var(--primary-light);
        color: var(--primary-dark);
        border: 2px dashed var(--primary);
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-weight: 600;
        transition: all 0.2s;
    }

    #addStageBtn:hover {
        background: var(--primary);
        color: #fff;
    }

    .form-actions {
        margin-top: 30px;
        text-align: center;
    }

    #tripMessage {
        margin-top: 15px;
        font-weight: bold;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="trip-card">
    <h2>Rejestracja nowej podróży</h2>
    <form id="tripForm">
        <input type="hidden" name="traveler_pesel" value="{{ traveler.pesel }}">

        <div id="stagesContainer">
            </div>

        <button type="button" id="addStageBtn">+ Dodaj kolejny etap podróży</button>

        <div class="form-actions">
            <button type="submit" class="btn">Zarejestruj podróż</button>
        </div>
    </form>
    <div id="tripMessage"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const tripForm = document.getElementById('tripForm');
const tripMessage = document.getElementById('tripMessage');
const stagesContainer = document.getElementById('stagesContainer');
const addStageBtn = document.getElementById('addStageBtn');

let countriesCache = [];

// 1. Pobieranie listy krajów
async function fetchCountries() {
    try {
        const res = await fetch('/countries');
        countriesCache = await res.json();
    } catch (err) {
        console.error("Błąd pobierania krajów:", err);
    }
}

// 2. Walidacja dat (czy wyjazd nie jest przed przyjazdem)
function validateStageDates(stageDiv) {
    const startInput = stageDiv.querySelector('.start-date-input');
    const endInput = stageDiv.querySelector('.end-date-input');
    const errorText = stageDiv.querySelector('.error-text');
    
    if (startInput.value && endInput.value) {
        const startDate = new Date(startInput.value);
        const endDate = new Date(endInput.value);

        if (endDate < startDate) {
            endInput.classList.add('input-error');
            errorText.style.display = 'block';
            errorText.textContent = "Błąd: Data wyjazdu jest wcześniej niż data przyjazdu!";
            return false;
        } else {
            endInput.classList.remove('input-error');
            errorText.style.display = 'none';
            return true;
        }
    }
    return true;
}

// 3. Dodawanie nowego etapu
async function addStage() {
    if (countriesCache.length === 0) await fetchCountries();

    const stageCount = stagesContainer.querySelectorAll('.stage').length + 1;
    
    // Pobierz datę zakończenia poprzedniego etapu
    let lastEndDate = "";
    const lastStage = stagesContainer.lastElementChild;
    if (lastStage) {
        lastEndDate = lastStage.querySelector('[name="end_date"]').value;
    }

    const div = document.createElement('div');
    div.className = 'stage';
    div.innerHTML = `
        <div class="stage-header">
            <strong>Etap #${stageCount}</strong>
            ${stageCount > 1 ? '<button type="button" class="removeStageBtn">Usuń ten etap</button>' : ''}
        </div>

        <div class="date-group">
            <div>
                <label>Data przyjazdu ${stageCount > 1 ? '(Zablokowana)' : ''}</label>
                <input type="date" name="start_date" 
                       class="input-field start-date-input ${stageCount > 1 ? 'input-readonly' : ''}" 
                       ${stageCount > 1 ? 'readonly' : ''} 
                       required value="${lastEndDate}">
            </div>
            <div>
                <label>Data wyjazdu</label>
                <input type="date" name="end_date" class="input-field end-date-input" required>
            </div>
        </div>
        <div class="error-text"></div>

        <label style="font-size: 12px; font-weight: bold;">Lokalizacja</label>
        <select class="input-field country-select" required>
            <option value="">-- Wybierz kraj --</option>
            ${countriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
        </select>

        <select class="input-field city-select" name="city_id" disabled required>
            <option value="">-- Najpierw wybierz kraj --</option>
        </select>

        <input type="text" name="address" class="input-field address-input" 
               placeholder="Adres pobytu (np. nazwa hotelu)" disabled required>
    `;

    stagesContainer.appendChild(div);

    // Selektory dla tego konkretnego etapu
    const countrySelect = div.querySelector('.country-select');
    const citySelect = div.querySelector('.city-select');
    const addressInput = div.querySelector('.address-input');
    const startInput = div.querySelector('.start-date-input');
    const endInput = div.querySelector('.end-date-input');

    // Obsługa zmiany daty wyjazdu (synchronizacja z następnym etapem)
    endInput.addEventListener('change', () => {
        validateStageDates(div);
        const nextStage = div.nextElementSibling;
        if (nextStage) {
            const nextStartInput = nextStage.querySelector('.start-date-input');
            nextStartInput.value = endInput.value;
            validateStageDates(nextStage);
        }
    });

    // Blokada dla pierwszego etapu (może zmieniać datę startu)
    if (stageCount === 1) {
        startInput.addEventListener('change', () => validateStageDates(div));
    }

    // Dynamiczne miasta
    countrySelect.addEventListener('change', async () => {
        const countryId = countrySelect.value;
        citySelect.innerHTML = '<option value="">Ładowanie...</option>';
        citySelect.disabled = true;
        addressInput.disabled = true;

        if (!countryId) return;

        try {
            const res = await fetch(`/countries/${countryId}/cities`);
            const cities = await res.json();
            citySelect.innerHTML = '<option value="">-- Wybierz miasto --</option>';
            cities.forEach(city => {
                citySelect.innerHTML += `<option value="${city.id}">${city.name}</option>`;
            });
            citySelect.disabled = false;
        } catch (err) {
            citySelect.innerHTML = '<option value="">Błąd ładowania</option>';
        }
    });

    citySelect.addEventListener('change', () => {
        addressInput.disabled = !citySelect.value;
    });

    // Usuwanie etapu
    if (stageCount > 1) {
        div.querySelector('.removeStageBtn').addEventListener('click', () => {
            const nextStage = div.nextElementSibling;
            const prevStage = div.previousElementSibling;
            div.remove();
            
            // Re-synchronizacja sąsiadów po usunięciu środka
            if (prevStage && nextStage) {
                nextStage.querySelector('.start-date-input').value = prevStage.querySelector('.end-date-input').value;
                validateStageDates(nextStage);
            }
            renumberStages();
        });
    }
}

// 4. Przenumerowanie etapów
function renumberStages() {
    stagesContainer.querySelectorAll('.stage').forEach((div, index) => {
        div.querySelector('.stage-header strong').textContent = `Etap #${index + 1}`;
    });
}

// 5. Inicjalizacja formularza
fetchCountries().then(() => addStage());
addStageBtn.addEventListener('click', addStage);

// 6. Przesyłanie danych
tripForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const allStagesDivs = stagesContainer.querySelectorAll('.stage');
    let isAllValid = true;
    
    // Sprawdzenie walidacji przed wysyłką
    allStagesDivs.forEach(stageDiv => {
        if (!validateStageDates(stageDiv)) isAllValid = false;
    });

    if (!isAllValid) {
        tripMessage.textContent = "Błąd: Popraw nieprawidłowe daty etapów.";
        tripMessage.style.color = "red";
        return;
    }

    const stages = [];
    allStagesDivs.forEach(div => {
        stages.push({
            start_date: div.querySelector('[name="start_date"]').value,
            end_date: div.querySelector('[name="end_date"]').value,
            city_id: parseInt(div.querySelector('[name="city_id"]').value),
            address: div.querySelector('[name="address"]').value
        });
    });

    // LOGIKA STATUSU
    // Dziś: 2026-01-22. Jeśli podróż zaczyna się wcześniej -> planned
    const firstStartDate = new Date(stages[0].start_date);
    const today = new Date("2026-01-22");
    const status = (firstStartDate > today) ? "planned" : "in_progress";

    const payload = {
        traveler_pesel: document.querySelector('[name="traveler_pesel"]').value,
        status: status,
        stages: stages
    };

    try {
        const res = await fetch('/trips', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await res.json();

        if (res.ok) {
            // Przekierowanie do osób towarzyszących po sukcesie
            window.location.href = `/add_companions_to_travel?traveler_pesel=${payload.traveler_pesel}&trip_id=${result.id}`;
        } else {
            tripMessage.textContent = "Błąd serwera: " + result.error;
            tripMessage.style.color = "red";
        }
    } catch (err) {
        tripMessage.textContent = "Błąd połączenia z serwerem.";
        tripMessage.style.color = "red";
    }
});
</script>
{% endblock %}