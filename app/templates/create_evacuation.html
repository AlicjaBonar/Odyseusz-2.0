{% extends "base.html" %}

{% block title %}Tworzenie ewakuacji - Odyseusz 2.0{% endblock %}

{% block content %}
<div class="register-card">
    <h1>Tworzenie ewakuacji</h1>
    <p class="subtitle">Zdefiniuj zakres i harmonogram ewakuacji</p>

    <form id="evacuationForm" class="loginForm">

        <!-- POLE NAZWY -->
        <div class="form-group">
            <input type="text" name="action_name" placeholder="Nazwa akcji ewakuacyjnej" required>
        </div>

        <!-- POLE OPISU -->
        <div class="form-group">
            <textarea name="event_description"
                    placeholder="Opis ewakuacji (sytuacja, zagrożenia, zalecenia)"
                    rows="4"
                    required></textarea>
        </div>
        
        <!-- DATA ROZPOCZECIA -->
        <div class="form-group">
            <label>Data rozpoczęcia:</label>
            <input type="datetime-local" name="start_date" required>
        </div>

        <!-- DATA ZAKOŃCZENIA -->
        <div class="form-group" id="endDateGroup">
            <label>Data zakończenia:</label>
            <input type="datetime-local" name="end_date" id="endDateInput">
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="noEndDate">
                Data zakończenia nieokreślona
            </label>
        </div>

        <!-- WYBÓR ZAKRESU -->
        <div class="form-group">
            <label class="radio-label">
                <input type="radio" name="scope" value="country" checked>
                Ewakuacja kraju
            </label>
            <label class="radio-label">
                <input type="radio" name="scope" value="city">
                Ewakuacja miasta
            </label>
        </div>

        <!-- KRAJ -->
        <div class="form-group" id="countryGroup">
            <select name="country_id" class="form-control">
                <option value="">Wybierz kraj</option>
                {% for country in countries %}
                    <option value="{{ country.id }}">{{ country.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- MIASTO -->
        <div class="form-group hidden" id="cityGroup">
            <select name="city_id" class="form-control">
                <option value="">Wybierz miasto</option>
                {% for city in cities %}
                    <option value="{{ city.id }}">{{ city.name }} ({{ city.country.name }})</option>
                {% endfor %}
            </select>
        </div>

        <!-- PRZYCISK -->
        <div class="form-actions" style="text-align:center; margin-top:1.5rem;">
            <button type="submit" class="btn">Utwórz ewakuację</button>
        </div>
        
    </form>

    <div id="message" style="margin-top:1rem; text-align:center;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // WYBÓR ZAKRESU
    const scopeRadios = document.querySelectorAll('input[name="scope"]');
    const countryGroup = document.getElementById('countryGroup');
    const cityGroup = document.getElementById('cityGroup');

    scopeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'country') {
                countryGroup.classList.remove('hidden');
                cityGroup.classList.add('hidden');
            } else {
                cityGroup.classList.remove('hidden');
                countryGroup.classList.add('hidden');
            }
        });
    });

    // DATA ZAKOŃCZENIA NIEOKREŚLONA
    const noEndDateCheckbox = document.getElementById('noEndDate');
    const endDateGroup = document.getElementById('endDateGroup');
    const endDateInput = document.getElementById('endDateInput');

    noEndDateCheckbox.addEventListener('change', () => {
        if (noEndDateCheckbox.checked) {
            endDateGroup.style.display = 'none';
            endDateInput.required = false;
        } else {
            endDateGroup.style.display = 'block';
            endDateInput.required = true;
        }
    });

    // SUBMIT FORMULARZA
    const form = document.getElementById('evacuationForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = Object.fromEntries(new FormData(form));
        if (noEndDateCheckbox.checked) data.end_date = null;

        const res = await fetch('/evacuations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await res.json();
        const msg = document.getElementById('message');

        if (res.ok) {
            msg.textContent = "Ewakuacja została utworzona";
            msg.style.color = "var(--accent)";
        } else {
            msg.textContent = result.error || "Błąd podczas tworzenia ewakuacji";
            msg.style.color = "var(--danger)";
        }
    });
</script>
{% endblock %}
