{% extends "base.html" %}

{% block title %}Tworzenie ewakuacji - Odyseusz 2.0{% endblock %}

{% block head %}
<style>
    .hidden { display: none; }
    .form-group { margin-bottom: 1.2rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
    .radio-label, .checkbox-label { font-weight: normal; display: inline-block; margin-right: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="register-card">
    <h1>Tworzenie ewakuacji</h1>
    <p class="subtitle">Zdefiniuj zakres i harmonogram ewakuacji</p>

    <form id="evacuationForm" class="loginForm">
        <div class="form-group">
            <input type="text" name="action_name" placeholder="Nazwa akcji ewakuacyjnej" class="form-control" required>
        </div>

        <div class="form-group">
            <textarea name="event_description" placeholder="Opis ewakuacji..." rows="4" class="form-control" required></textarea>
        </div>
        
        <div class="form-group">
            <label>Data rozpoczęcia:</label>
            <input type="datetime-local" name="start_date" class="form-control" required>
        </div>

        <div class="form-group" id="endDateGroup">
            <label>Data zakończenia:</label>
            <input type="datetime-local" name="end_date" id="endDateInput" class="form-control">
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="noEndDate"> Data zakończenia nieokreślona
            </label>
        </div>

        <div class="form-group">
            <label>Zakres ewakuacji:</label>
            <label class="radio-label">
                <input type="radio" name="scope" value="country" checked> Ewakuacja kraju
            </label>
            <label class="radio-label">
                <input type="radio" name="scope" value="city"> Ewakuacja miasta
            </label>
        </div>

        <div class="form-group" id="countryGroup">
            <label>Kraj:</label>
            <select name="country_id" id="countrySelect" class="form-control" required>
                <option value="">Ładowanie krajów...</option>
            </select>
        </div>

        <div class="form-group hidden" id="cityGroup">
            <label>Miasto:</label>
            <select name="city_id" id="citySelect" class="form-control">
                <option value="">Wybierz kraj, aby zobaczyć miasta</option>
            </select>
        </div>

        <div class="form-actions" style="text-align:center; margin-top:1.5rem;">
            <button type="submit" class="btn">Utwórz ewakuację</button>
        </div>
    </form>

    <div id="message" style="margin-top:1rem; text-align:center;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const countrySelect = document.getElementById('countrySelect');
    const citySelect = document.getElementById('citySelect');
    const scopeRadios = document.querySelectorAll('input[name="scope"]');
    const cityGroup = document.getElementById('cityGroup');
    const form = document.getElementById('evacuationForm');

    // --- NOWA FUNKCJA: POBIERANIE MIAST ---
    async function updateCities() {
        const countryId = countrySelect.value;
        const currentScope = document.querySelector('input[name="scope"]:checked').value;

        // Czyścimy listę miast, jeśli nie ma kraju lub zmieniliśmy na zakres "kraj"
        if (!countryId || currentScope !== 'city') {
            citySelect.innerHTML = '<option value="">Wybierz kraj, aby zobaczyć miasta</option>';
            return;
        }

        citySelect.innerHTML = '<option value="">Ładowanie miast...</option>';
        
        try {
            const res = await fetch(`/countries/${countryId}/cities`);
            if (!res.ok) throw new Error("Błąd pobierania");
            const cities = await res.json();
            
            citySelect.innerHTML = '<option value="">-- Wybierz miasto --</option>';
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city.id;
                opt.textContent = city.name;
                citySelect.appendChild(opt);
            });
        } catch (e) {
            citySelect.innerHTML = '<option value="">Błąd ładowania miast</option>';
        }
    }

    // 1. POBIERANIE KRAJÓW PRZY STARCIE (bez zmian)
    async function loadCountries() {
        try {
            const res = await fetch('/countries');
            const countries = await res.json();
            
            countrySelect.innerHTML = '<option value="">-- Wybierz kraj --</option>';
            countries.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                countrySelect.appendChild(opt);
            });
        } catch (e) {
            countrySelect.innerHTML = '<option value="">Błąd ładowania krajów</option>';
        }
    }

    // 2. REAKCJA NA ZMIANĘ KRAJU
    countrySelect.addEventListener('change', updateCities);

    // 3. REAKCJA NA ZMIANĘ ZAKRESU (Kraj/Miasto)
    scopeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'city') {
                cityGroup.classList.remove('hidden');
                citySelect.required = true;
                // WYWOŁUJEMY AKTUALIZACJĘ: jeśli kraj był już wybrany, dociągnie miasta
                updateCities(); 
            } else {
                cityGroup.classList.add('hidden');
                citySelect.required = false;
                citySelect.value = "";
            }
        });
    });

    // 4. DATA ZAKOŃCZENIA (bez zmian)
    const noEndDateCheckbox = document.getElementById('noEndDate');
    const endDateGroup = document.getElementById('endDateGroup');
    const endDateInput = document.getElementById('endDateInput');

    noEndDateCheckbox.addEventListener('change', () => {
        endDateGroup.classList.toggle('hidden', noEndDateCheckbox.checked);
        endDateInput.required = !noEndDateCheckbox.checked;
    });

    // 5. WYSYŁKA FORMULARZA (bez zmian)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const scope = formData.get('scope');

        const payload = {
            action_name: formData.get('action_name'),
            event_description: formData.get('event_description'), // Musi być tak samo jak w Service
            start_date: formData.get('start_date'),
            end_date: noEndDateCheckbox.checked ? null : formData.get('end_date'),
            country_id: parseInt(formData.get('country_id')),
            city_id: scope === 'city' ? parseInt(formData.get('city_id')) : null
        };

        try {
            const res = await fetch('/evacuations/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            const msg = document.getElementById('message');

            if (res.ok) {
                msg.textContent = "Ewakuacja została pomyślnie utworzona!";
                msg.style.color = "green";
                form.reset();
                cityGroup.classList.add('hidden');
            } else {
                msg.textContent = "Błąd: " + (result.error || "Nieznany błąd");
                msg.style.color = "red";
            }
        } catch (err) {
            console.error(err);
        }
    });

    loadCountries();
</script>
{% endblock %}