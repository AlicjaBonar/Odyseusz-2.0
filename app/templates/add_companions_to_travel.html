{% extends "base.html" %}

{% block title %}Dodawanie uczestników – Odyseusz 2.0{% endblock %}

{% block head %}
<style>
    .companion { margin-bottom: 10px; }
    .companion input { margin-right: 5px; }
    #companionsContainer { margin-top: 10px; }
</style>
{% endblock %}

{% block content %}
<h2>Dodawanie uczestników do podróży</h2>

<p id="question">Czy chcesz dodać innych uczestników do wycieczki?</p>
<button id="yesBtn">Tak</button>
<button id="noBtn">Nie</button>

<form id="companionsForm" style="display: none;">
    <h3>Dodaj uczestników</h3>
    <div id="companionsContainer"></div>
    <button type="button" id="addCompanionBtn">Dodaj uczestnika</button>
    <br><br>
    <button type="submit">Zapisz uczestników</button>
    <br><br>
    <button type="button" id="cancelBtn">Anuluj dodawanie uczestniów</button>
</form>

<div id="message"></div>
{% endblock %}

{% block scripts %}
<script>
// Trip i podróżny przekazane z backendu
const tripId = "{{ trip_id }}";
const travelerPesel = "{{ traveler_pesel }}";

const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const cancelBtn = document.getElementById('cancelBtn');
const companionsForm = document.getElementById('companionsForm');
const companionsContainer = document.getElementById('companionsContainer');
const addCompanionBtn = document.getElementById('addCompanionBtn');
const message = document.getElementById('message');
const question = document.getElementById('question');

// Pokazanie formularza po kliknięciu "Tak"
yesBtn.addEventListener('click', () => {
    companionsForm.style.display = 'block';
    question.style.display = 'none';
    yesBtn.style.display = 'none';
    noBtn.style.display = 'none';
});

// Przekierowanie po kliknięciu "Nie"
noBtn.addEventListener('click', () => {
    companionsForm.style.display = 'none';
    window.location.href = "/thanks_for_registering_trip";
});

// Przycisk anulowania formularza
cancelBtn.addEventListener('click', () => {
    companionsForm.style.display = 'none';
    window.location.href = "/thanks_for_registering_trip";
});

// Dodawanie nowego uczestnika
function addCompanion() {
    const div = document.createElement('div');
    div.className = 'companion';
    div.innerHTML = `
        <input type="text" name="first_name" placeholder="Imię" required>
        <input type="text" name="last_name" placeholder="Nazwisko" required>
        <input type="text" name="pesel" placeholder="PESEL">
        <input type="number" name="age" placeholder="Wiek">
        <input type="text" name="phone_number" placeholder="Telefon">
        <input type="email" name="email" placeholder="Email">
        <button type="button" class="removeBtn">Usuń</button>
    `;
    companionsContainer.appendChild(div);

    div.querySelector('.removeBtn').addEventListener('click', () => div.remove());
}

addCompanionBtn.addEventListener('click', addCompanion);

// Obsługa wysyłki formularza
companionsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const companions = [];
    companionsContainer.querySelectorAll('.companion').forEach(div => {
        const inputs = div.querySelectorAll('input');
        companions.push({
            first_name: inputs[0].value,
            last_name: inputs[1].value,
            pesel: inputs[2].value,
            age: inputs[3].value ? parseInt(inputs[3].value) : null,
            phone_number: inputs[4].value,
            email: inputs[5].value
        });
    });

    if (companions.length === 0) {
        message.textContent = "Nie dodano żadnych uczestników.";
        return;
    }

    try {
        const res = await fetch(`/trips/${tripId}/companions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companions, traveler_pesel: travelerPesel })
        });

        const result = await res.json();

        if (res.ok) {
            window.location.href = "/thanks_for_registering_trip";
        } else {
            message.textContent = `Błąd: ${result.error}`;
        }
    } catch (err) {
        message.textContent = `Błąd sieci: ${err.message}`;
    }
});
</script>
{% endblock %}
